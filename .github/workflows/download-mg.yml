name: Download MG Renderer Latest Release

on:
  schedule:
    # æ¯30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
    - cron: '*/30 * * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/download-mg.yml'

permissions:
  contents: write
  actions: read

jobs:
  download-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup directories
      run: |
        echo "ğŸ• å·¥ä½œæµå¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
        echo "ğŸ”„ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
        mkdir -p mg

    - name: Get latest MG release info
      id: release
      run: |
        echo "è·å– MobileGlues æœ€æ–°å‘å¸ƒä¿¡æ¯..."
        release_data=$(curl --silent "https://api.github.com/repos/MobileGL-Dev/MobileGlues-release/releases/latest")
        latest_tag=$(echo "$release_data" | jq -r '.tag_name')
        if [ "$latest_tag" = "null" ] || [ -z "$latest_tag" ]; then
          echo "âŒ æ— æ³•è·å–æœ€æ–°ç‰ˆæœ¬æ ‡ç­¾"
          exit 1
        fi
        echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT
        echo "release_data<<EOF" >> $GITHUB_OUTPUT
        echo "$release_data" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "æ£€æµ‹åˆ°æœ€æ–°ç‰ˆæœ¬æ ‡ç­¾: $latest_tag"

    - name: Check if version needs update
      id: version_check
      run: |
        latest_tag="${{ steps.release.outputs.latest_tag }}"

        # åˆå§‹åŒ– needs_update ä¸º trueï¼ˆå‡è®¾éœ€è¦æ›´æ–°ï¼‰
        needs_update="true"

        # æ£€æŸ¥ latest åˆ†æ”¯æ˜¯å¦å­˜åœ¨
        if git show-ref --verify --quiet refs/remotes/origin/latest; then
          echo "åˆ‡æ¢åˆ° latest åˆ†æ”¯è¯»å–å½“å‰ç‰ˆæœ¬..."
          git checkout latest
          git pull origin latest

          VERSION_FILE="mg/version.txt"
          if [ -f "$VERSION_FILE" ]; then
            current_tag=$(cat "$VERSION_FILE")
            echo "å½“å‰å·²åŒæ­¥ç‰ˆæœ¬: $current_tag"
            if [ "$current_tag" == "$latest_tag" ]; then
              echo "å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
              needs_update="false"
            else
              echo "æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬: $latest_tag (å½“å‰: $current_tag)"
            fi
          else
            echo "latest åˆ†æ”¯ä¸­æœªæ‰¾åˆ° mg/version.txtï¼Œè§†ä¸ºéœ€è¦æ›´æ–°"
          fi

          # åˆ‡å›é»˜è®¤åˆ†æ”¯ï¼ˆmain/masterï¼‰
          git checkout ${{ github.ref_name }}
        else
          echo "latest åˆ†æ”¯ä¸å­˜åœ¨ï¼Œè§†ä¸ºé¦–æ¬¡è¿è¡Œï¼Œéœ€è¦æ›´æ–°"
        fi

        echo "needs_update=$needs_update" >> $GITHUB_OUTPUT

    - name: Clean and Download MG APK
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        echo "å¼€å§‹ä¸‹è½½ MobileGlues APK..."

        # æå– APK URLï¼ˆå–ç¬¬ä¸€ä¸ª .apkï¼‰
        apk_url=$(echo '${{ steps.release.outputs.release_data }}' | jq -r '.assets[] | select(.name | endswith(".apk")) | .browser_download_url' | head -n1)
        if [ -z "$apk_url" ]; then
          echo "âŒ æœªæ‰¾åˆ° APK æ–‡ä»¶"
          exit 1
        fi

        echo "APK ä¸‹è½½åœ°å€: $apk_url"
        target="mg/MG-release.apk"
        mkdir -p "$(dirname "$target")"

        if wget --progress=bar:force -c "$apk_url" -O "$target" 2>&1; then
          if [ -s "$target" ]; then
            echo "âœ… APK ä¸‹è½½æˆåŠŸï¼Œå¤§å°: $(du -h "$target" | cut -f1)"
          else
            echo "âŒ APK æ–‡ä»¶ä¸ºç©º"
            exit 1
          fi
        else
          echo "âŒ wget ä¸‹è½½å¤±è´¥"
          exit 1
        fi

    - name: Configure Git
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: Generate release body with timestamp
      if: steps.version_check.outputs.needs_update == 'true'
      id: release_body
      run: |
        export TZ=Asia/Shanghai
        current_time=$(date '+%Y-%m-%d %H:%M:%S %Z')
        echo "body<<EOF" >> $GITHUB_OUTPUT
        echo "MobileGlues æ¸²æŸ“å™¨ (MG Renderer) ç‰ˆæœ¬ ${{ steps.release.outputs.latest_tag }}" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "è‡ªåŠ¨ä»å®˜æ–¹ä»“åº“åŒæ­¥çš„æœ€æ–°ç‰ˆæœ¬ã€‚" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "**åŒæ­¥ä¿¡æ¯ï¼š**" >> $GITHUB_OUTPUT
        echo "- ğŸ• åŒæ­¥æ—¶é—´: ${current_time}" >> $GITHUB_OUTPUT
        echo "- ğŸ“¦ æ¥æº: [MobileGL-Dev/MobileGlues-release](https://github.com/MobileGL-Dev/MobileGlues-release)" >> $GITHUB_OUTPUT
        echo "- ğŸ“„ æ–‡ä»¶å: MG-release.apk" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create/Update GitHub Release for MG
      if: steps.version_check.outputs.needs_update == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: MG
        name: MobileGlues ${{ steps.release.outputs.latest_tag }}
        body: ${{ steps.release_body.outputs.body }}
        files: mg/MG-release.apk
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Update version record in latest branch
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        latest_tag="${{ steps.release.outputs.latest_tag }}"

        # åˆ‡æ¢æˆ–åˆ›å»º latest åˆ†æ”¯
        if git show-ref --verify --quiet refs/remotes/origin/latest; then
          git checkout latest
          git pull origin latest
        else
          git checkout --orphan latest
          git rm -rf .  # æ¸…ç©ºå†å²ï¼ˆä»…ä¿ç•™å¹²å‡€åˆ†æ”¯ï¼‰
        fi

        # å†™å…¥ç‰ˆæœ¬æ–‡ä»¶åˆ° mg/ ç›®å½•
        mkdir -p mg
        echo "$latest_tag" > mg/version.txt

        git add mg/version.txt
        git commit -m "Update MG version to $latest_tag"
        git push origin latest --force  # ç¡®ä¿æ¨é€æˆåŠŸï¼ˆé¦–æ¬¡å¯èƒ½éœ€ --set-upstreamï¼‰

        echo "âœ… å·²æ›´æ–° latest åˆ†æ”¯ä¸­çš„ mg/version.txt"

    - name: Summary
      run: |
        if [ "${{ steps.version_check.outputs.needs_update }}" == "true" ]; then
          echo "âœ… æˆåŠŸåŒæ­¥å¹¶å‘å¸ƒ MobileGlues ç‰ˆæœ¬ ${{ steps.release.outputs.latest_tag }}"
          echo "ğŸš€ APK å·²ä¸Šä¼ è‡³ Release (tag: MG)"
          echo "ğŸ“‹ ç‰ˆæœ¬è®°å½•å·²å†™å…¥ latest åˆ†æ”¯çš„ mg/version.txt"
          echo "ğŸ”— Release é“¾æ¥: https://github.com/${{ github.repository }}/releases/tag/MG"
        else
          echo "â„¹ï¸ MobileGlues å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
        fi
