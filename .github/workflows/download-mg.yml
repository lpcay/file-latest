name: Download MG Renderer Latest Release

on:
  schedule:
    # æ¯30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
    - cron: '*/30 * * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/download-mg.yml'

permissions:
  contents: write
  actions: read

jobs:
  download-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        lfs: false

    - name: Setup directories
      run: |
        echo "ğŸ• å·¥ä½œæµå¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
        echo "ğŸ”„ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
        mkdir -p mg

    - name: Get latest MG release info
      id: release
      run: |
        echo "è·å– MobileGlues æœ€æ–°å‘å¸ƒä¿¡æ¯..."
        release_data=$(curl --silent "https://api.github.com/repos/MobileGL-Dev/MobileGlues-release/releases/latest")
        latest_tag=$(echo "$release_data" | jq -r '.tag_name')
        latest_version=$(echo "$latest_tag" | sed 's/^V//')  # å»æ‰å‰ç¼€ Vï¼Œå¦‚ V1.3.3 â†’ 1.3.3
        echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT
        echo "latest_version=$latest_version" >> $GITHUB_OUTPUT
        echo "release_data<<EOF" >> $GITHUB_OUTPUT
        echo "$release_data" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "æ£€æµ‹åˆ°æœ€æ–°ç‰ˆæœ¬æ ‡ç­¾: $latest_tag (ç‰ˆæœ¬å·: $latest_version)"

    - name: Check if version needs update
      id: version_check
      run: |
        latest_tag="${{ steps.release.outputs.latest_tag }}"
        latest_version="${{ steps.release.outputs.latest_version }}"

        if [ "$latest_tag" = "null" ] || [ -z "$latest_tag" ]; then
          echo "è­¦å‘Š: æ— æ³•è·å–æœ‰æ•ˆçš„ç‰ˆæœ¬æ ‡ç­¾ï¼Œè·³è¿‡ä¸‹è½½"
          echo "needs_update=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        # æ£€æŸ¥ latest-mg åˆ†æ”¯æ˜¯å¦å­˜åœ¨
        if git show-ref --verify --quiet refs/remotes/origin/latest-mg; then
          echo "åˆ‡æ¢åˆ° latest-mg åˆ†æ”¯æ£€æŸ¥ç‰ˆæœ¬..."
          git checkout latest-mg
          git pull origin latest-mg

          VERSION_FILE="mg/version.txt"
          if [ -f "$VERSION_FILE" ]; then
            current_tag=$(cat "$VERSION_FILE")
            echo "è¯»å–åˆ°å½“å‰ç‰ˆæœ¬æ ‡ç­¾: $current_tag"
            echo "æœ€æ–°ç‰ˆæœ¬æ ‡ç­¾: $latest_tag"

            if [ "$current_tag" == "$latest_tag" ]; then
              echo "å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ ($latest_tag)ï¼Œè·³è¿‡ä¸‹è½½"
              echo "needs_update=false" >> $GITHUB_OUTPUT
            else
              echo "æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬: $latest_tag (å½“å‰: $current_tag)"
              echo "needs_update=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "latest-mg åˆ†æ”¯å­˜åœ¨ä½†æœªæ‰¾åˆ°ç‰ˆæœ¬è®°å½•æ–‡ä»¶"
            echo "needs_update=true" >> $GITHUB_OUTPUT
          fi

          # åˆ‡å›ä¸»åˆ†æ”¯
          git checkout ${{ github.ref_name }}
        else
          echo "latest-mg åˆ†æ”¯ä¸å­˜åœ¨ï¼Œå¼€å§‹ä¸‹è½½æœ€æ–°ç‰ˆæœ¬ ($latest_tag)"
          echo "needs_update=true" >> $GITHUB_OUTPUT
        fi

    - name: Clean old files
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        echo "æ¸…ç†æ—§ç‰ˆæœ¬æ–‡ä»¶..."
        rm -f mg/MG-release.apk

    - name: Download MG APK
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        echo "å¼€å§‹ä¸‹è½½ MobileGlues APK..."

        # æå– APK ä¸‹è½½ URLï¼ˆå‡è®¾åªæœ‰ä¸€ä¸ª APKï¼‰
        apk_url=$(echo '${{ steps.release.outputs.release_data }}' | jq -r '.assets[] | select(.name | endswith(".apk")) | .browser_download_url' | head -n1)

        if [ -z "$apk_url" ]; then
          echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° APK æ–‡ä»¶"
          exit 1
        fi

        echo "APK ä¸‹è½½åœ°å€: $apk_url"
        target_path="mg/MG-release.apk"

        mkdir -p "$(dirname "$target_path")"
        echo "æ­£åœ¨ä¸‹è½½å¹¶ä¿å­˜ä¸º: $target_path"

        if wget --progress=bar:force -c "$apk_url" -O "$target_path" 2>&1; then
          if [ -f "$target_path" ] && [ -s "$target_path" ]; then
            file_size=$(du -h "$target_path" | cut -f1)
            echo "âœ… ä¸‹è½½å®Œæˆ! æ–‡ä»¶å¤§å°: $file_size"
            ls -la "$target_path"
          else
            echo "âŒ é”™è¯¯: æ–‡ä»¶ä¸‹è½½åä¸ºç©ºæˆ–ä¸å­˜åœ¨"
            exit 1
          fi
        else
          echo "âŒ wget ä¸‹è½½å¤±è´¥"
          exit 1
        fi

    - name: Update version file
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        echo "${{ steps.release.outputs.latest_tag }}" > mg/version.txt
        echo "å·²æ›´æ–°ç‰ˆæœ¬è®°å½•: mg/version.txt"

    - name: Configure Git
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: Generate release body with timestamp
      if: steps.version_check.outputs.needs_update == 'true'
      id: release_body
      run: |
        export TZ=Asia/Shanghai
        current_time=$(date '+%Y-%m-%d %H:%M:%S %Z')
        echo "body<<EOF" >> $GITHUB_OUTPUT
        echo "MobileGlues æ¸²æŸ“å™¨ (MG Renderer) ç‰ˆæœ¬ ${{ steps.release.outputs.latest_tag }}" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "è‡ªåŠ¨ä»å®˜æ–¹ä»“åº“åŒæ­¥çš„æœ€æ–°ç‰ˆæœ¬ã€‚" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "**åŒæ­¥ä¿¡æ¯ï¼š**" >> $GITHUB_OUTPUT
        echo "- ğŸ• åŒæ­¥æ—¶é—´: ${current_time}" >> $GITHUB_OUTPUT
        echo "- ğŸ“¦ æ¥æº: [MobileGL-Dev/MobileGlues-release](https://github.com/MobileGL-Dev/MobileGlues-release)" >> $GITHUB_OUTPUT
        echo "- ğŸ“„ æ–‡ä»¶å: MG-release.apkï¼ˆé€šç”¨ç‰ˆæœ¬ï¼‰" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create/Update GitHub Release for MG
      if: steps.version_check.outputs.needs_update == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: MG
        name: MobileGlues ${{ steps.release.outputs.latest_tag }}
        body: ${{ steps.release_body.outputs.body }}
        files: mg/MG-release.apk
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Switch to latest-mg branch and update version record
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        current_tag="${{ steps.release.outputs.latest_tag }}"

        # æ¸…ç†å¯èƒ½å†²çªçš„æ–‡ä»¶
        rm -f mg/version.txt

        if git show-ref --verify --quiet refs/remotes/origin/latest-mg; then
          echo "åˆ‡æ¢åˆ° existing latest-mg åˆ†æ”¯"
          git checkout latest-mg
          git pull origin latest-mg
        else
          echo "åˆ›å»ºæ–°çš„ latest-mg åˆ†æ”¯"
          git checkout -b latest-mg
        fi

        mkdir -p mg
        echo "$current_tag" > mg/version.txt
        git add mg/version.txt

        if ! git diff --staged --quiet; then
          git commit -m "Update MG version to $current_tag"
          git push origin latest-mg
          echo "âœ… å·²æ›´æ–° latest-mg åˆ†æ”¯çš„ç‰ˆæœ¬è®°å½•"
        fi

    - name: Summary
      run: |
        if [ "${{ steps.version_check.outputs.needs_update }}" == "true" ]; then
          echo "âœ… æˆåŠŸå‘å¸ƒ MobileGlues ç‰ˆæœ¬ ${{ steps.release.outputs.latest_tag }}"
          echo "ğŸš€ APK æ–‡ä»¶å·²ä¸Šä¼ åˆ° GitHub Release (tag: MG)"
          echo "ğŸ“‹ ç‰ˆæœ¬è®°å½•å·²æ›´æ–°åˆ° latest-mg åˆ†æ”¯"
          echo "ğŸ“¦ æ–‡ä»¶: mg/MG-release.apk"
          echo "ğŸ”— Release é“¾æ¥: https://github.com/${{ github.repository }}/releases/tag/MG"
        else
          echo "â„¹ï¸ MobileGlues å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
        fi
