name: Download FCL Latest Release

on:
  schedule:
    # æ¯10åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆGitHub Actionså®é™…æœ€å°æœ‰æ•ˆé—´éš”ï¼‰
    - cron: '*/10 * * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/download-fcl.yml'

permissions:
  contents: write
  actions: read

jobs:
  download-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        lfs: true

    - name: Setup directories
      run: |
        echo "ğŸ• å·¥ä½œæµå¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
        echo "ğŸ”„ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
        mkdir -p fcl
        
    - name: Get latest FCL release info
      id: release
      run: |
        echo "è·å–æœ€æ–°å‘å¸ƒä¿¡æ¯..."
        release_data=$(curl --silent "https://api.github.com/repos/FCL-Team/FoldCraftLauncher/releases/latest")
        latest_version=$(echo "$release_data" | jq -r '.tag_name')
        echo "latest_version=$latest_version" >> $GITHUB_OUTPUT
        echo "release_data<<EOF" >> $GITHUB_OUTPUT
        echo "$release_data" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        echo "æ£€æµ‹åˆ°æœ€æ–°ç‰ˆæœ¬: $latest_version"

    - name: Check if version needs update
      id: version_check
      run: |
        latest_version="${{ steps.release.outputs.latest_version }}"
        
        # æ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦æœ‰æ•ˆ
        if [ "$latest_version" = "null" ] || [ -z "$latest_version" ]; then
          echo "è­¦å‘Š: æ— æ³•è·å–æœ‰æ•ˆçš„ç‰ˆæœ¬ä¿¡æ¯ (ç‰ˆæœ¬: $latest_version)ï¼Œè·³è¿‡ä¸‹è½½"
          echo "needs_update=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # æ£€æŸ¥lateståˆ†æ”¯æ˜¯å¦å­˜åœ¨å¹¶åˆ‡æ¢åˆ°è¯¥åˆ†æ”¯è¯»å–ç‰ˆæœ¬æ–‡ä»¶
        if git show-ref --verify --quiet refs/remotes/origin/latest; then
          echo "åˆ‡æ¢åˆ°lateståˆ†æ”¯æ£€æŸ¥ç‰ˆæœ¬..."
          git checkout latest
          git pull origin latest
          
          VERSION_FILE="fcl/releases.txt"
          if [ -f "$VERSION_FILE" ]; then
            current_version=$(cat "$VERSION_FILE")
            echo "è¯»å–åˆ°å½“å‰ç‰ˆæœ¬: $current_version"
            echo "æœ€æ–°ç‰ˆæœ¬: $latest_version"
            
            if [ "$current_version" == "$latest_version" ]; then
              echo "å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ ($latest_version)ï¼Œè·³è¿‡ä¸‹è½½"
              echo "needs_update=false" >> $GITHUB_OUTPUT
            else
              echo "æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬: $latest_version (å½“å‰ç‰ˆæœ¬: $current_version)"
              echo "needs_update=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "lateståˆ†æ”¯å­˜åœ¨ä½†æœªæ‰¾åˆ°ç‰ˆæœ¬è®°å½•æ–‡ä»¶"
            echo "needs_update=true" >> $GITHUB_OUTPUT
          fi
          
          # åˆ‡æ¢å›ä¸»åˆ†æ”¯ç»§ç»­åç»­æ“ä½œ
          git checkout ${{ github.ref_name }}
        else
          echo "lateståˆ†æ”¯ä¸å­˜åœ¨ï¼Œå¼€å§‹ä¸‹è½½æœ€æ–°ç‰ˆæœ¬ ($latest_version)"
          echo "needs_update=true" >> $GITHUB_OUTPUT
        fi

    - name: Clean old files
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        echo "æ¸…ç†æ—§ç‰ˆæœ¬æ–‡ä»¶..."
        rm -f fcl/FCL-release-*.apk

    - name: Download APK files
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        echo "å¼€å§‹ä¸‹è½½APKæ–‡ä»¶åˆ°ç›®å½•: fcl/"
        
        # æ–‡ä»¶åä¿®å¤å‡½æ•°
        fix_filename() {
          local original_name="$1"
          
          # å¤„ç†æ‰€æœ‰æ¶æ„ç±»å‹
          if [[ "$original_name" =~ FCL-release-[0-9.]+-(.+)\.apk$ ]]; then
            local arch_part="${BASH_REMATCH[1]}"
            echo "FCL-release-${arch_part}.apk"
          # å¤„ç†allæ¶æ„çš„ç‰¹æ®Šæƒ…å†µ
          elif [[ "$original_name" =~ FCL-release-[0-9.]+\.apk$ ]]; then
            echo "FCL-release-all.apk"
          # å¤„ç†æ— æ¶æ„æ ‡è¯†çš„æ–‡ä»¶å
          elif [[ "$original_name" =~ FCL-release-[0-9.]+(\.apk)$ ]]; then
            echo "FCL-release-all.apk"
          else
            # å¦‚æœéƒ½ä¸åŒ¹é…ï¼Œè¿”å›åŸå§‹åç§°
            echo "$original_name"
          fi
        }
        
        # è·å–æ‰€æœ‰APKä¸‹è½½é“¾æ¥å¹¶ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶
        echo '${{ steps.release.outputs.release_data }}' | jq -r '.assets[] | select(.name | test("^FCL-release.*\\.apk$")) | .browser_download_url' > /tmp/apk_urls.txt
        
        echo "æ‰¾åˆ°çš„ä¸‹è½½é“¾æ¥:"
        cat /tmp/apk_urls.txt
        
        # å¤„ç†æ¯ä¸ªAPKèµ„æº
        while IFS= read -r url; do
          if [ -z "$url" ]; then
            continue
          fi
          
          # æå–åŸå§‹æ–‡ä»¶å
          original_name=$(basename "$url")
          
          # ä½¿ç”¨ä¿®å¤åçš„æ–‡ä»¶åå¤„ç†å‡½æ•°
          new_name=$(fix_filename "$original_name")
          target_path="fcl/$new_name"
          
          echo "ä¸‹è½½: $original_name â†’ ä¿å­˜ä¸º: $target_path"
          echo "URL: $url"
          
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          mkdir -p "$(dirname "$target_path")"
          
          # ä¸‹è½½æ–‡ä»¶ï¼Œæ˜¾ç¤ºè¯¦ç»†è¾“å‡º
          echo "å¼€å§‹ä¸‹è½½..."
          if wget --progress=bar:force -c "$url" -O "$target_path" 2>&1; then
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©º
            if [ -f "$target_path" ] && [ -s "$target_path" ]; then
              file_size=$(du -h "$target_path" | cut -f1)
              echo "âœ… ä¸‹è½½å®Œæˆ! æ–‡ä»¶å¤§å°: $file_size"
              ls -la "$target_path"
              echo "--------------------------------------------------"
            else
              echo "âŒ é”™è¯¯: æ–‡ä»¶ä¸‹è½½åä¸å­˜åœ¨æˆ–ä¸ºç©º"
              ls -la fcl/ || echo "fclç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
          else
            echo "âŒ é”™è¯¯: wgetå‘½ä»¤å¤±è´¥ - $url"
            exit 1
          fi
        done < /tmp/apk_urls.txt
        
        # æ˜¾ç¤ºæœ€ç»ˆä¸‹è½½ç»“æœ
        echo "æ‰€æœ‰ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶åˆ—è¡¨:"
        ls -la fcl/
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f /tmp/apk_urls.txt

    - name: Update version file
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        echo "${{ steps.release.outputs.latest_version }}" > fcl/releases.txt
        echo "å·²æ›´æ–°ç‰ˆæœ¬è®°å½•: fcl/releases.txt"

    - name: Configure Git
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: Generate release body with timestamp
      if: steps.version_check.outputs.needs_update == 'true'
      id: release_body
      run: |
        export TZ=Asia/Shanghai
        current_time=$(date '+%Y-%m-%d %H:%M:%S %Z')
        echo "body<<EOF" >> $GITHUB_OUTPUT
        echo "FCL (FoldCraftLauncher) ç‰ˆæœ¬ ${{ steps.release.outputs.latest_version }}" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "è‡ªåŠ¨ä»å®˜æ–¹ä»“åº“åŒæ­¥çš„æœ€æ–°ç‰ˆæœ¬ã€‚" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "**åŒæ­¥ä¿¡æ¯ï¼š**" >> $GITHUB_OUTPUT
        echo "- ğŸ• åŒæ­¥æ—¶é—´: ${current_time}" >> $GITHUB_OUTPUT
        echo "- ğŸ“¦ æ¥æº: [FCL-Team/FoldCraftLauncher](https://github.com/FCL-Team/FoldCraftLauncher)" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "**æ–‡ä»¶ç”¨é€”æè¿°ï¼š**" >> $GITHUB_OUTPUT
        echo "- FCL-release-all.apk - é€šç”¨ç‰ˆæœ¬" >> $GITHUB_OUTPUT
        echo "- FCL-release-arm64-v8a.apk - ARM64æ¶æ„" >> $GITHUB_OUTPUT
        echo "- FCL-release-armeabi-v7a.apk - ARM32æ¶æ„" >> $GITHUB_OUTPUT
        echo "- FCL-release-x86.apk - x86æ¶æ„" >> $GITHUB_OUTPUT
        echo "- FCL-release-x86_64.apk - x86_64æ¶æ„" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create/Update GitHub Release
      if: steps.version_check.outputs.needs_update == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: FCL
        name: ${{ steps.release.outputs.latest_version }}
        body: ${{ steps.release_body.outputs.body }}
        files: |
          fcl/*.apk
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Switch to latest branch and update version
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        # æš‚å­˜å½“å‰ç‰ˆæœ¬ä¿¡æ¯
        current_version="${{ steps.release.outputs.latest_version }}"
        
        # æ¸…ç†å·¥ä½œç›®å½•ä¸­å¯èƒ½å†²çªçš„æ–‡ä»¶
        rm -f fcl/releases.txt
        
        # æ£€æŸ¥lateståˆ†æ”¯æ˜¯å¦å­˜åœ¨
        if git show-ref --verify --quiet refs/remotes/origin/latest; then
          echo "åˆ‡æ¢åˆ°existing lateståˆ†æ”¯"
          git checkout latest
          git pull origin latest
        else
          echo "åˆ›å»ºæ–°çš„lateståˆ†æ”¯"
          git checkout -b latest
        fi
        
        # åªä¿å­˜ç‰ˆæœ¬è®°å½•æ–‡ä»¶åˆ°lateståˆ†æ”¯
        mkdir -p fcl
        echo "$current_version" > fcl/releases.txt
        
        git add fcl/releases.txt
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
        if ! git diff --staged --quiet; then
          git commit -m "Update version to $current_version"
          git push origin latest
          echo "å·²æ›´æ–°lateståˆ†æ”¯çš„ç‰ˆæœ¬è®°å½•"
        fi

    - name: Summary
      run: |
        if [ "${{ steps.version_check.outputs.needs_update }}" == "true" ]; then
          echo "âœ… æˆåŠŸå‘å¸ƒFCLç‰ˆæœ¬ ${{ steps.release.outputs.latest_version }}"
          echo "ğŸš€ APKæ–‡ä»¶å·²ä¸Šä¼ åˆ°GitHub Release"
          echo "ğŸ“‹ ç‰ˆæœ¬è®°å½•å·²æ›´æ–°åˆ°lateståˆ†æ”¯"
          
          # æ˜¾ç¤ºä¸‹è½½çš„æ–‡ä»¶åˆ—è¡¨
          echo "ğŸ“¦ å‘å¸ƒçš„æ–‡ä»¶:"
          ls -la fcl/*.apk 2>/dev/null || echo "æœªæ‰¾åˆ°APKæ–‡ä»¶"
          
          echo "ğŸ”— Releaseé“¾æ¥: https://github.com/${{ github.repository }}/releases/tag/FCL"
        else
          echo "â„¹ï¸ å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°"
        fi